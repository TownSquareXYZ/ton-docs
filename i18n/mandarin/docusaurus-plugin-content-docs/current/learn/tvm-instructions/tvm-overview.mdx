import Button from '@site/src/components/button'

# TVM Overview

本文提供了TVM如何执行交易的概览。

This document provides a bird's-eye view of how TVM executes transactions.

:::tip

- TVM Source — [**TVM C++ implementation**](https://github.com/ton-blockchain/ton/tree/master/crypto/vm)
  :::

## TON Course: TVM

每个交易包含最多 5 个阶段：

Module 2 completely covers **TVM**, transactions, scalability and business cases.

<Button href="https://stepik.org/course/176754/" colorType={'primary'} sizeType={'sm'}>Check TON Blockchain Course</Button>

## Transactions and phases

When some event happens on the account in one of the TON chains, it causes a **transaction**. The most common event is the "arrival of some message", but generally speaking there could be `tick-tock`, `merge`, `split` and other events.

在任何给定时刻，TVM 状态由 6 个属性完全确定：

1. Stack - （见下文）
2. Control registers - （见下文）简单地说，这意味着最多可在执行期间直接设置和读取的 16 个变量
3. Current continuation - 描述当前执行的指令序列的对象
4. Current codepage - 简单地说，这表示当前正在运行的 TVM 版本
5. Gas limits - 一组 4 个整数值；当前 gas 限制 g<sub>l</sub>、最大 gas 限制 g<sub>m</sub>、剩余 gas  g<sub>r</sub> 和 gas 信用 g<sub>c</sub>

## TVM 是堆栈机

TVM 是一个后进先出的堆栈机。总共有 7 种类型的变量可以存储在堆栈中 — 三种非cell类型：

### TVM state

以及四种不同的cell类型：

- Cell(cell) - TON 区块链用于存储所有数据的基本（可能是嵌套的）不透明结构
- Slice(切片) - 一种特殊的对象，允许从cell中读取
- Builder(构建器) - 一种特殊的对象，允许您创建新的cell
- Continuation(延续对象) - 一种特殊的对象，允许您将cell TVM 指令的源
- Gas limits - a set of 4 integer values; the current gas limit g<sub>l</sub>, the maximal gas limit g<sub>m</sub>, the remaining gas g<sub>r</sub> and the gas credit g<sub>c</sub>
- Library context - the hashmap of libraries which can be called by TVM 

### 控制寄存器

TVM is a last-input-first-output stack machine. In total, there are 7 types of variables which may be stored in stack — three non-cell types:

- Integer - signed 257-bit integers
- Tuple - ordered collection of up to 255 elements having arbitrary value types, possibly distinct.
- Null

TVM 在事务执行到达 Compute Phase 时初始化，然后从 _当前 continuation_ 执行命令（操作码），直到没有更多的命令要执行（并且没有用于返回跳转的 continuation）。

- Cell - basic (possibly nested) opaque structure used by TON Blockchain for storing all data
- Slice - a special object which allows you to read from a cell
- Builder - a special object which allows you to create new cells
- Continuation - a special object which allows you to use a cell as source of TVM instructions

### TVM 指令

- `c0` — Contains the next continuation or return continuation (similar to the subroutine return address in conventional designs). This value must be a Continuation.
- `c1` — Contains the alternative (return) continuation; this value must be a Continuation. 
- `c2` — Contains the exception handler. This value is a Continuation, invoked whenever an exception is triggered.
- `c3` — Supporting register, contains the current dictionary, essentially a hashmap containing the code of all functions used in the program. This value must be a Continuation. 
- `c4` — Contains the root of persistent data, or simply the `data` section of the contract. This value is a Cell.
- `c5` — Contains the output actions. This value is a Cell.
- `c7` — Contains the root of temporary data. It is a Tuple.

### TVM 执行的结果

除了 `exit_code` 和消耗的 gas 数据之外，TVM 还间接输出以下数据：

Detailed description of the initialization process can be found here: [TVM Initialization](/learn/tvm-instructions/tvm-initialization.md)

## TVM instructions

请注意，由于最大cell深度 `<1024` 以及特别是 c4 和 c5 深度 `<=512` 的限制，一次 tx 中的输出动作数量将受到限制 `<=255`。如果合约需要发送的消息超过这个限制，它可以发送带有请求 `continue_sending` 的消息给自己，并在随后的交易中发送所有必要的消息。

### 参见

Besides exit_code and consumed gas data, TVM indirectly outputs the following data:

- c4 register - the cell which will be stored as new `data` of the smart-contract (if execution will not be reverted on this or later phases)
- c5 register - (list of output actions) the cell with last action in the list and reference to the cell with prev action (recursively)

All other register values will be neglected.

Note, that since there is a limit on max cell-depth `<1024`, and particularly the limit on c4 and c5 depth `<=512`, there will be a limit on the number of output actions in one tx `<=255`. If a contract needs to send more than that, it may send a message with the request `continue_sending` to itself and send all necessary messages in subsequent transactions.

## See Also

- [TVM Instructions](/learn/tvm-instructions/instructions)
- [TON TVM](https://ton.org/tvm.pdf) TVM Concepts(may include outdated information)
