# بلاکچینی از بلاکچین‌ها

:::tip
اصطلاحات '**قرارداد هوشمند**'، '**حساب**' و '**بازیگر**' به طور متناوب در این سند برای توصیف یک نهاد بلاکچین استفاده می‌شوند.
:::

## بازیگر تکی

بیایید یک قرارداد هوشمند را در نظر بگیریم.

در TON، این یک *جزء* است که ویژگی‌هایی مانند `address`، `code`، `data`، `balance` و غیره دارد. به عبارت دیگر، این یک شیء است که مقداری *فضای ذخیره سازی* و *واکنش* دارد.
این واکنش الگوی زیر را دارد:

- چیزی اتفاق می‌افتد (شایع‌ترین وضعیت این است که یک قرارداد پیامی دریافت می‌کند)
- قرارداد این رویداد را بر اساس ویژگی‌های خود با اجرای `code` خود در ماشین مجازی TON مدیریت می‌کند.
- قرارداد ویژگی‌های خود را تغییر می‌دهد (`code`، `data` و غیره)
- قرارداد به‌طور اختیاری پیام‌های خروجی تولید می‌کند
- قرارداد تا وقوع رویداد بعدی به حالت آماده‌باش می‌رود

ترکیبی از این مراحل را **تراکنش** می‌نامند. مهم است که رویدادها تک به تک مدیریت شوند، بنابراین *تراکنش‌ها* به‌طور دقیق مرتب می‌شوند و نمی‌توانند اجرای یکدیگر را قطع کنند.

این الگوی رفتاری به خوبی شناخته شده است و به نام 'بازیگر' شناخته می‌شود.

### پایین‌ترین سطح: زنجیره حساب

یک توالی از *تراکنش‌ها* `Tx1 -> Tx2 -> Tx3 -> ....` ممکن است به عنوان یک **زنجیره** نامیده شود. و در مثال مورد نظر ما به آن **AccountChain** گفته می‌شود تا تاکید شود که این *زنجیره* یک حساب واحد از تراکنش‌ها است.

حالا، از آنجا که گره‌هایی که تراکنش‌ها را پردازش می‌کنند نیاز دارند هر لحظه به هماهنگی وضعیت قرارداد هوشمند بپردازند (برای رسیدن به *اجماع* در مورد وضعیت) آن *تراکنش‌ها* به صورت دسته‌ای بسته‌بندی می‌شوند:
`[Tx1 -> Tx2] -> [Tx3 -> Tx4 -> Tx5] -> [] -> [Tx6]`.
دسته‌بندی در ترتیب‌بندی دخالت نمی‌کند، هر تراکنش هنوز فقط یک 'tx قبلی' و حداکثر یک 'tx بعدی' دارد، اما حالا این توالی به **بلوک‌ها** برش داده می‌شود.

*بلوک‌ها* همچنین شامل صف‌های پیام‌های ورودی و خروجی هستند که مفید است. به این صورت که یک *بلوک* مجموعه کاملی از اطلاعاتی که تعیین و توصیف می‌کند چه چیزی برای قرارداد هوشمند در طول آن بلوک اتفاق افتاده است، را شامل می‌شود.

## بسیاری از AccountChains: شاردها

حالا بیایید بسیاری از حساب‌ها را در نظر بگیریم. می‌توانیم چند *AccountChains* بدست آوریم و آنها را با هم ذخیره کنیم، چنین مجموعه‌ای از *AccountChains* به عنوان **ShardChain** نامیده می‌شود. به همین ترتیب، می‌توانیم **ShardChain** را به **ShardBlocks** برش دهیم، که تجمیعی از *AccountBlocks* جداگانه هستند.

### تقسیم و ادغام پویا شاردها

توجه داشته باشید که از آنجا که یک *ShardChain* از *AccountChains* قابل تشخیص تشکیل شده است، ما می‌توانیم به راحتی آن را تقسیم کنیم. به این ترتیب، اگر ما یک *ShardChain* داریم که رویدادهایی را که با یک میلیون حساب اتفاق می‌افتد توصیف می‌کند و تراکنش‌های زیادی در هر ثانیه برای پردازش و ذخیره در یک گره وجود دارد، پس ما فقط آن زنجیره را به دو *ShardChain* کوچکتر تقسیم می‌کنیم که هر زنجیره نیمی از حساب‌ها را پوشش می‌دهد و هر زنجیره بر روی یک زیرمجموعه جداگانه از گره‌ها پردازش می‌شود.

به‌طور مشابه، اگر برخی از شاردها مدت زیادی بیکار شدند، می‌توان آنها را به یک شارد بزرگتر **ادغام** کرد.

بدیهی است که دو حالت محدود وجود دارد: زمانی که شارد فقط یک حساب را شامل می‌شود (بنابراین نمی‌تواند بیشتر تقسیم شود) و زمانی که شارد همه حساب‌ها را شامل می‌شود.

حساب‌ها می‌توانند با ارسال پیام به یکدیگر تعامل کنند. یک مکانیزم ویژه مسیریابی وجود دارد که پیام‌ها را از صف‌های خروجی به صف‌های ورودی مربوط منتقل می‌کند و اطمینان می‌دهد که: 1) همه پیام‌ها تحویل داده می‌شوند 2) پیام‌ها به ترتیب تحویل داده می‌شوند (پیامی که زودتر ارسال شده زودتر به مقصد می‌رسد).

:::info نکته جانبی
برای تعیین قطعی تقسیم و ادغام، تجمیع AccountChains به شاردها بر اساس نمایش بیتی از آدرس‌های حساب انجام می‌شود. به عنوان مثال، آدرس به شکل `(shard prefix, address)` به نظر می‌رسد. به این ترتیب، همه حساب‌ها در شاردچین دقیقاً همان پیشوند باینری را خواهند داشت (به عنوان مثال همه آدرس‌ها با `0b00101` شروع می‌شوند).
:::

## بلاکچین

تجمیع تمام شاردها که شامل همه حساب‌هایی است که با یک مجموعه از قوانین عمل می‌کنند، **بلاکچین** نامیده می‌شود.

در TON ممکن است مجموعه‌های زیادی از قوانین وجود داشته باشد و در نتیجه بلاکچین‌های زیادی که به‌طور همزمان عمل می‌کنند و می‌توانند با ارسال پیام به صورت زنجیره متقاطع به همان شیوه‌ای که حساب‌های یک زنجیره می‌توانند با هم داشته باشند، با یکدیگر تعامل کنند.

### زنجیره کار: بلاکچین با قوانین اختصاصی خودتان

اگر می‌خواهید قوانین گروهی از شاردچین‌ها را سفارشی کنید، می‌توانید یک **Workchain** ایجاد کنید. یک مثال خوب ایجاد یک زنجیره کار است که بر اساس EVM کار کند تا قراردادهای هوشمند Solidity را بر روی آن اجرا شود.

به‌طور تئوری، همه افراد جامعه می‌توانند زنجیره کار خود را ایجاد کنند اما در واقع، این کار بسیار پیچیده‌ای است! پس از آنکه هزینه (گران) ایجاد آن را پرداخت کنید و 2/3 آرا از اعتبارسنج‌ها برای تأیید ایجاد زنجیره کار خود را دریافت کنید میتوانید بلاکچین با قوانین خودتان داشته باشید.

در TON این امکان وجود دارد تا حداکثر `2^32` زنجیره کار ایجاد شود، که هر یک به حداکثر `2^60` شارد تقسیم می‌شود.

امروزه، فقط 2 زنجیره کار در TON وجود دارد: MasterChain و BaseChain.

BaseChain برای تراکنش‌های روزمره بین بازیگران استفاده می‌شود زیرا بسیار ارزان است، در حالی که MasterChain دارای یک عملکرد حیاتی برای TON است، پس بیایید کاری که انجام می دهد را پوشش دهیم!

### MasterChain: بلاکچینی از بلاکچین‌ها

نیاز به هماهنگی مسیریابی پیام‌ها و اجرای تراکنش‌ها وجود دارد. به عبارت دیگر، گره‌های شبکه نیاز دارند که راهی برای تثبیت برخی از 'نقاط' در وضعیت چند زنجیره‌ای پیدا کنند و به یک اجماع در مورد آن وضعیت برسند. در TON، یک زنجیره خاص به نام **MasterChain** برای این منظور استفاده می‌شود. بلوک‌های *MasterChain* شامل اطلاعات اضافی (آخرین هش بلوک‌ها) در مورد همه زنجیره‌های دیگر در سیستم هستند، بنابراین هر ناظری به‌طور واضح وضعیت همه سیستم‌های چند زنجیره‌ای را در یک بلوک MasterChain تعیین می‌کند.
