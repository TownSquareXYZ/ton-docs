# TVM در مقابل EVM

ماشین مجازی اتریوم (EVM) و ماشین مجازی TON (TVM) هر دو ماشین‌های مجازی مبتنی بر پشته هستند که برای اجرای کد قراردادهای هوشمند توسعه داده شده‌اند. با وجود ویژگی‌های مشترک، تفاوت‌های قابل توجهی بین آن‌ها وجود دارد.

## نمایش داده‌ها

### ماشین مجازی اتریوم (EVM)

1. واحدهای داده اصلی

- EVM عمدتاً بر روی اعداد صحیح ۲۵۶ بیتی عمل می‌کند که طراحی آن حول توابع رمزنگاری اتریوم (مانند هش Keccak-256 و عملیات منحنی بیضوی) است.
- انواع داده‌ها عمدتاً به اعداد صحیح، بایت‌ها و گاهی آرایه‌های این انواع محدود می‌شوند، اما همه باید به قوانین پردازش ۲۵۶ بیتی پایبند باشند.

2. ذخیره‌سازی حالت

- کل وضعیت بلاکچین اتریوم یک نگاشت از آدرس‌های ۲۵۶ بیتی به مقادیر ۲۵۶ بیتی است. این نگاشت در یک ساختار داده به نام Merkle Patricia Trie (MPT) نگهداری می‌شود.
- MPT به اتریوم امکان می‌دهد تا به طور مؤثر سازگاری و یکپارچگی وضعیت بلاکچین را از طریق تأیید رمزنگاری اثبات کند که برای یک سیستم غیرمتمرکز مانند اتریوم حیاتی است.

3. محدودیت‌های ساختار داده

- ساده‌سازی به محدودیت‌های کلمه ۲۵۶ بیتی به این معنی است که EVM به طور ذاتی برای مدیریت ساختارهای داده پیچیده یا سفارشی طراحی نشده است.
- توسعه‌دهندگان اغلب نیاز به پیاده‌سازی منطق اضافی در داخل قراردادهای هوشمند دارند تا ساختارهای داده پیچیده‌تر را شبیه‌سازی کنند که می‌تواند به هزینه‌های گس و پیچیدگی بیشتری منجر شود.

### ماشین مجازی TON (TVM)

1. معماری مبتنی بر سلول

- TVM از یک مدل منحصر به فرد "کیف سلول‌ها" برای نمایش داده‌ها استفاده می‌کند. هر سلول می‌تواند تا ۱۲۸ بایت داده داشته باشد و می‌تواند تا ۴ مرجع به سلول‌های دیگر داشته باشد.
- این ساختار به TVM امکان می‌دهد تا به طور ذاتی از انواع داده جبری دلخواه و ساختارهای پیچیده‌تری مانند درخت‌ها یا گراف‌های غیر حلقه‌ای جهت‌دار (DAG) به طور مستقیم در مدل ذخیره‌سازی خود پشتیبانی کند.

2. انعطاف‌پذیری و کارایی

- مدل سلول انعطاف‌پذیری قابل توجهی را فراهم می‌کند و به TVM امکان می‌دهد تا انواع مختلفی از ساختارهای داده را به طور طبیعی‌تر و کارآمدتر از EVM مدیریت کند.
- به عنوان مثال، توانایی ایجاد ساختارهای متصل از طریق مراجع سلول، امکان ساختارهای داده پویا و احتمالاً بی‌نهایت را فراهم می‌کند که برای برخی از انواع برنامه‌ها مانند شبکه‌های اجتماعی غیرمتمرکز یا پروتکل‌های مالی غیرمتمرکز (DeFi) پیچیده حیاتی است.

3. مدیریت داده‌های پیچیده

- توانایی مدیریت انواع داده پیچیده به طور ذاتی در معماری VM نیاز به پیاده‌سازی راه‌حل‌های موقت در قراردادهای هوشمند را کاهش می‌دهد که ممکن است هزینه اجرا را کاهش داده و سرعت اجرا را افزایش دهد.
- طراحی TVM به ویژه برای برنامه‌هایی که نیاز به مدیریت حالت پیچیده یا ساختارهای داده متصل دارند، مزیت بزرگی دارد و بنیاد محکمی برای توسعه‌دهندگان برای ساخت برنامه‌های غیرمتمرکز پیچیده و مقیاس‌پذیر فراهم می‌کند.

## ماشین پشته

### ماشین مجازی اتریوم (EVM)

- EVM به عنوان یک ماشین پشته‌ای سنتی عمل می‌کند، جایی که از یک پشته با اصل آخرین ورودی، اولین خروجی (LIFO) برای مدیریت محاسبات استفاده می‌کند.
- عملیات‌ها را با فشردن و پاپ کردن اعداد صحیح ۲۵۶ بیتی پردازش می‌کند که اندازه استاندارد برای همه عناصر در پشته است.

### ماشین مجازی TON (TVM)

- TVM نیز به عنوان یک ماشین پشته‌ای عمل می‌کند اما با یک تفاوت کلیدی: از اعداد صحیح ۲۵۷ بیتی و مراجع به سلول‌ها پشتیبانی می‌کند.
- این امکان به TVM می‌دهد تا این دو نوع داده متمایز را بر روی/از پشته فشار داده و پاپ کند، که در دستکاری مستقیم داده‌ها انعطاف‌پذیری بیشتری فراهم می‌کند.

### مثال عملیات پشته

فرض کنید می‌خواهیم دو عدد (2 و 2) را در EVM جمع کنیم. فرآیند شامل فشردن اعداد به پشته و سپس فراخوانی دستور `ADD` خواهد بود. نتیجه (4) در بالای پشته باقی می‌ماند.

ما می‌توانیم این عملیات را به همان روش در TVM انجام دهیم. اما بیایید به مثال دیگری با ساختارهای داده پیچیده‌تر مانند هش‌مپ‌ها و مرجع سلول نگاه کنیم. فرض کنید یک هش‌مپ داریم که جفت‌های کلید-مقدار را ذخیره می‌کند، جایی که کلیدها اعداد صحیح و مقادیر یا اعداد صحیح یا مراجع سلول هستند. فرض کنید هش‌مپ ما حاوی مدخل‌های زیر است:

```js
{
    1: 10
    2: cell_a (which contains 10)
}
```

ما می‌خواهیم مقادیر مرتبط با کلیدهای ۱ و ۲ را جمع کنیم و نتیجه را با کلید ۳ ذخیره کنیم. بیایید به عملیات‌های پشته نگاه کنیم:

1. کلید ۱ را به پشته فشار دهید: `stack` = (1)
2. فراخوانی `DICTGET` برای کلید ۱ (مقداری را که با کلید در بالای پشته مرتبط است بازیابی می‌کند): مقدار ۱۰ را بازیابی می‌کند. `stack` = (10)
3. کلید ۲ را به پشته فشار دهید: `stack` = (10, 2)
4. فراخوانی `DICTGET` برای کلید ۲: مرجع به Cell_A را بازیابی می‌کند. `stack` = (10, Cell_A)
5. مقدار را از Cell_A بارگذاری کنید: یک دستور برای بارگذاری مقدار از مرجع سلول اجرا می‌شود. `stack` = (10, 10)
6. فراخوانی دستور `ADD`: هنگامی که دستور `ADD` اجرا می‌شود، TVM دو عنصر بالای پشته را پاپ می‌کند، آن‌ها را جمع می‌کند و نتیجه را به پشته فشار می‌دهد. در این حالت، دو عنصر بالای پشته ۱۰ و ۱۰ هستند. پس از جمع، پشته حاوی نتیجه خواهد بود: `stack` = (20)
7. کلید ۳ را به پشته فشار دهید: `stack` = (20, 3)
8. فراخوانی `DICTSET`: مقدار ۲۰ را با کلید ۳ ذخیره می‌کند. هش‌مپ به‌روزشده:

```js
{
    1: 10,
    2: cell_a,
    3: 20
}
```

برای انجام همین کار در EVM، نیاز به تعریف یک نگاشت داریم که جفت‌های کلید-مقدار را ذخیره می‌کند و تابعی که مستقیماً با اعداد صحیح ۲۵۶ بیتی ذخیره شده در نگاشت کار می‌کنیم.
مهم است که توجه داشته باشید که EVM از ساختارهای داده پیچیده پشتیبانی می‌کند با استفاده از Solidity، اما این ساختارها بر روی مدل داده ساده‌تر EVM ساخته شده‌اند که به طور اساسی با مدل داده بیشتر بیانگر TVM متفاوت است

## عملگرهای ریاضی

### ماشین مجازی اتریوم (EVM)

- ماشین مجازی اتریوم (EVM) عملیات ریاضی را با استفاده از اعداد صحیح ۲۵۶ بیتی انجام می‌دهد، به این معنی که عملیات‌هایی مانند جمع، تفریق، ضرب و تقسیم برای این اندازه داده طراحی شده‌اند.

### ماشین مجازی TON (TVM)

- ماشین مجازی TON (TVM) از مجموعه متنوع‌تری از عملیات‌های ریاضی پشتیبانی می‌کند، از جمله اعداد صحیح ۶۴ بیتی، ۱۲۸ بیتی و ۲۵۶ بیتی، هم بدون علامت و هم با علامت، و همچنین عملیات مدولار. TVM قابلیت‌های ریاضی خود را با عملیات‌هایی مانند ضرب-سپس-شیفت و شیفت-سپس-تقسیم بهبود می‌بخشد که به‌ویژه برای پیاده‌سازی ریاضیات ثابت‌نقطه مفید هستند. این تنوع به توسعه‌دهندگان اجازه می‌دهد تا براساس نیازهای خاص قراردادهای هوشمند خود، کارآمدترین عملیات ریاضی را انتخاب کنند و بهینه‌سازی‌های ممکن را براساس اندازه و نوع داده ارائه دهند.

## بررسی‌های سرریز

### ماشین مجازی اتریوم (EVM)

- در EVM، بررسی‌های سرریز به طور ذاتی توسط ماشین مجازی انجام نمی‌شود. با معرفی Solidity 0.8.0، بررسی‌های خودکار سرریز و زیرسرریز به زبان افزوده شدند تا امنیت را افزایش دهند. این بررسی‌ها به جلوگیری از ضعف‌های رایج مربوط به عملیات‌های ریاضی کمک می‌کنند، اما نیاز به نسخه‌های جدیدتر Solidity دارند، زیرا نسخه‌های قبلی نیاز به پیاده‌سازی دستی این حفاظت‌ها داشتند.

### ماشین مجازی TON (TVM)

- در مقابل، TVM به‌طور خودکار بررسی‌های سرریز را بر روی تمام عملیات‌های ریاضی انجام می‌دهد، که این ویژگی مستقیماً در ماشین مجازی ساخته شده است. این انتخاب طراحی توسعه قراردادهای هوشمند را با کاهش ذاتی خطر خطاها و افزایش اطمینان و امنیت کلی کد ساده می‌کند.

## رمزنگاری و توابع هش

### ماشین مجازی اتریوم (EVM)

- EVM از سیستم رمزنگاری خاص اتریوم، مانند منحنی بیضوی secp256k1 و تابع هش keccak256 پشتیبانی می‌کند. همچنین، EVM پشتیبانی داخلی از اثبات‌های مرکل ندارد، که اثبات‌های رمزنگاری برای تأیید عضویت یک عنصر در یک مجموعه هستند.

### ماشین مجازی TON (TVM)

- TVM از رمزنگاری منحنی بیضوی 256 بیتی (ECC) برای منحنی‌های از پیش تعریف شده، مانند Curve25519، پشتیبانی می‌کند. همچنین، از ترکیب‌های Weil در برخی از منحنی‌های بیضوی پشتیبانی می‌کند که برای پیاده‌سازی سریع zk-SNARKs (اثبات‌های بدون دانش) مفید هستند. توابع هش محبوب مانند sha256 نیز پشتیبانی می‌شوند، که گزینه‌های بیشتری برای عملیات‌های رمزنگاری ارائه می‌دهد. علاوه بر این، TVM می‌تواند با اثبات‌های مرکل کار کند، که ویژگی‌های رمزنگاری اضافی ارائه می‌دهد که برای برخی از موارد استفاده مفید است، مانند تأیید شامل شدن یک تراکنش در یک بلوک.

## زبان‌های سطح بالا

### ماشین مجازی اتریوم (EVM)

- EVM عمدتاً از Solidity به عنوان زبان سطح بالای خود استفاده می‌کند، که یک زبان شیءگرا و دارای نوع‌سنجی ایستا است که شبیه جاوا اسکریپت و C++ است. همچنین، زبان‌های دیگری برای نوشتن قراردادهای هوشمند اتریوم مانند Vyper، Yul و غیره وجود دارد.

### ماشین مجازی TON (TVM)

- TVM از FunC به عنوان یک زبان سطح بالا استفاده می‌کند که برای نوشتن قراردادهای هوشمند TON طراحی شده است. این یک زبان رویه‌ای با نوع‌سنجی ایستا و پشتیبانی از انواع داده جبری است. FunC به Fift کامپایل می‌شود که به نوبه خود به بایت‌کد TVM کامپایل می‌شود.

## نتیجه‌گیری

در خلاصه، در حالی که هر دو EVM و TVM ماشین‌های مبتنی بر پشته هستند که برای اجرای قراردادهای هوشمند طراحی شده‌اند، TVM انعطاف‌پذیری بیشتری، پشتیبانی از انواع داده و ساختارهای گسترده‌تر، بررسی‌های سرریز داخلی و ویژگی‌های رمزنگاری پیشرفته ارائه می‌دهد.

پشتیبانی TVM از قراردادهای هوشمند آگاه به شاردینگ و رویکرد منحصر به فرد آن در نمایش داده‌ها آن را برای برخی موارد استفاده و شبکه‌های بلاکچین مقیاس‌پذیر بهتر مناسب می‌کند.
