import Feedback from '@site/src/components/Feedback';

# Highload wallet contracts

When working with many messages in a short period, there is a need for special wallet called Highload wallet. Highload wallet v2 was the main wallet on TON for a long time, but you had to be very careful with it. Otherwise, you could [lock all funds](https://t.me/tonstatus/88).

[با ورود والت های لود بالا V3](https://github.com/ton-blockchain/Highload-wallet-contract-v3)، این مشکل در سطح معماری قرارداد حل شده و مصرف گاز کمتری دارد. این فصل به معرفی مبانی والت‌های لود بالا V3 و نکات مهمی که باید به یاد داشته باشید می‌پردازد.

## Highload wallet v3

این کیف‌پول برای کسانی که نیاز به ارسال تراکنش با سرعت بسیار بالا دارند ساخته شده است. برای مثال، صرافی‌های ارزهای دیجیتال.

- [کد منبع](https://github.com/ton-blockchain/Highload-wallet-contract-v3)

هر پیام خارجی داده شده (درخواست انتقال) به های لود V3 شامل موارد زیر است:

- یک امضا (۵۱۲ بیت) در cell سطح بالا - سایر پارامترها در ref آن cell قرار دارند
- شناسه کیف‌پول فرعی (۳۲ بیت)
- پیام برای ارسال به عنوان یک ref (پیام داخلی سریالی شده که ارسال خواهد شد)
- حالت ارسال برای پیام (۸ بیت)
- شناسه پرس‌وجوی ترکیبی - ۱۳ بیت برای "شیفت" و ۱۰ بیت برای "شماره بیت"، با این حال ۱۰ بیت شماره بیت تنها تا ۱۰۲۲ می‌تواند برود و نه ۱۰۲۳، و همچنین آخرین شناسه پرس‌وجوی قابل استفاده (۸۳۸۸۶۰۵) برای مواقع اضطراری رزرو شده و نباید به طور عادی استفاده شود
- زمان ایجاد، یا تایم‌استمپ پیام
- تایم‌اوت

تایم‌اوت به عنوان یک پارامتر در والت لود بالا ذخیره می‌شود و در برابر تایم‌اوت در تمامی درخواست‌ها بررسی می‌شود - بنابراین تایم‌اوت برای تمامی درخواست‌ها برابر است. پیام نباید در زمان ورود به کیف‌پول لود بالا قدیمی‌تر از تایم‌اوت باشد، یا در کد نیاز است که `created_at > now() - timeout`. شناسه‌های پرس‌وجو حداقل برای مدت تایم‌اوت ذخیره می‌شوند و احتمالاً تا ۲ \* تایم‌اوت، اما نباید انتظار داشت که بیشتر از تایم‌اوت ذخیره شوند. شناسه کیف‌پول فرعی با آنچه که در کیف‌پول ذخیره شده تطبیق داده می‌شود. هش ref داخلی به همراه امضا با کلید عمومی کیف‌پول بررسی می‌شود.

کیف‌پول لود بالا v3 تنها می‌تواند ۱ پیام از هر پیام خارجی ارسال کند، هر چند می‌تواند با یک کد عملیاتی خاص این پیام را به خود ارسال کند، که اجازه می‌دهد هر cell عملیاتی را در آن فراخوانی پیام داخلی تنظیم کنید، به طور موثر امکان ارسال تا ۲۵۴ پیام در هر پیام خارجی را فراهم می‌آورد (احتمالاً بیشتر اگر پیام دیگری در میان این ۲۵۴ پیام به کیف‌پول لود بالا ارسال شود).

Highload v3 پس از گذراندن تمامی بررسی‌ها، همیشه شناسه پرس‌وجو (حفاظت در برابر تکرار) را ذخیره می‌کند، اما پیام به دلیل برخی شرایط، از جمله اما نه محدود به موارد زیر، ممکن است ارسال نشود:

- **شامل حالت ایجاد وضعیت** (چنین پیام‌هایی، در صورت لزوم، می‌توانند با استفاده از کد عملیاتی خاصی که برای تنظیم cell عملیاتی پس از یک پیام داخلی از والت لود بالا به خود ارسال می‌شوند)
- موجودی ناکافی
- ساختار پیام نامعتبر (شامل پیام‌های خروجی خارجی - تنها پیام‌های داخلی می‌توانند مستقیماً از پیام خارجی ارسال شوند)

والت لود بالا V3 هرگز چندین پیام خارجی که همان `query_id` و `created_at` را داشته باشند اجرا نخواهد کرد - زمانی که یک `query_id` داده را فراموش کند، شرط `created_at` از اجرای چنین پیام‌هایی جلوگیری خواهد کرد. این عملاً باعث می‌شود `query_id` و `created_at` به طور مشترک "کلید اصلی" یک درخواست انتقال برای والت لود بالا V3 باشد.

در هنگام تکرار (افزایش) شناسه پرس‌وجو، ارزان‌تر است (از لحاظ TONهایی که برای هزینه‌ها مصرف می‌شود) که ابتدا از طریق شماره بیت و سپس از طریق شیفت همانند زمانی که یک عدد معمولی را افزایش می‌دهید، تکرار کنید. بعد از رسیدن به آخرین شناسه پرس‌وجو (به شناسه پرس‌وجوی اضطراری فکر کنید - به بالاتر مراجعه کنید)، می‌توانید شناسه پرس‌وجو را به ۰ برگردانید، اما اگر مدت تاخیر Highload هنوز نگذشته است، دیکشنری حفاظتی تکرار پر خواهد شد و باید منتظر بمانید تا مدت تاخیر بگذرد.

## والت لود بالا v2

:::danger
قرارداد قدیمی، پیشنهاد می‌شود از والت لود بالا v3 استفاده کنید.
:::

این کیف‌پول برای آنهایی که نیاز به ارسال صدها تراکنش در مدت زمان کوتاهی دارند ساخته شده است. برای مثال، صرافی‌های ارزهای دیجیتال.

این قابلیت را دارد که در یک تماس با قرارداد هوشمند می‌توانید تا `254` تراکنش ارسال کنید. همچنین از رویکردی کمی متفاوت برای حل حملات تکراری به جای seqno استفاده می‌کند، بنابراین می‌توانید این کیف‌پول را چندین بار به طور همزمان برای ارسال هزاران تراکنش در ثانیه صدا بزنید.

:::caution محدودیت‌ها
توجه، هنگام کار با والت لود بالا نیاز است که محدودیت‌های زیر بررسی شوند و به آنها توجه شود.
:::

1. **محدودیت حجم ذخیره‌سازی.** در حال حاضر، اندازه ذخیره‌سازی قرارداد باید کمتر از 65535 cell باشد. اگر اندازه_old_queries بالاتر از این حد رشد کند، در ActionPhase استثناء ایجاد می‌شود و تراکنش شکست می‌خورد. تراکنش شکست‌خورده ممکن است دوباره اجرا شود.
2. **محدودیت گاز.** در حال حاضر، محدودیت گاز 1'000'000 واحد GAS است، که به این معناست که محدودیتی در تعداد old queries وجود دارد که ممکن است در یک تراکنش حذف شوند. اگر تعداد پرس‌وجوهای منقضی شده بیشتر باشد، قرارداد متوقف خواهد شد.

That means that it is not recommended to set too high expiration date:
the number of queries during expiration time span should not exceed 1000.

Also, the number of expired queries cleaned in one transaction should be below 100.

## How to

شما می‌توانید مقاله [راهنمای‌های Highload Wallet](/v3/guidelines/smart-contracts/howto/wallet#-high-load-wallet-v3) را نیز مطالعه کنید.

کد منبع Wallet:

- [ton/crypto/smartcont/Highload-wallet-v2-code.fc](https://github.com/ton-blockchain/ton/blob/master/crypto/smartcont/new-highload-wallet-v2.fif)

<Feedback />

