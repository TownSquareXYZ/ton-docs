# حالت‌های پایدار

گره‌ها به طور دوره‌ای اسنپ‌شات‌هایی از حالت‌های بلاکچین ذخیره می‌کنند. هر حالت در یک بلاک مسترچین خاص ایجاد می‌شود و دارای TTL است. انتخاب بلاک و TTL با استفاده از الگوریتم زیر انجام می‌شود:

تنها بلاک‌های کلیدی می‌توانند انتخاب شوند. یک بلاک دارای مهر زمانی `ts` است. دوره‌های زمانی به طول `2^17` ثانیه (تقریباً ۱/۵ روز) وجود دارد. دوره یک بلاک با مهر زمانی `ts` برابر است با `x = floor(ts / 2^17)`. اولین بلاک کلیدی هر دوره برای ایجاد حالت پایدار انتخاب می‌شود.

TTL یک حالت از دوره `x` برابر است با `2^(18 + ctz(x))`، که در آن `ctz(x)` تعداد صفرهای پسین در نمایش باینری `x` است (یعنی بزرگترین `y` که `x` بر `2^y` بخش‌پذیر است).

این بدان معناست که حالت‌های پایدار هر ۱/۵ روز ایجاد می‌شوند، نصف آنها عمر (TTL) به میزان `2^18` ثانیه (3 روز) دارند، نصف باقی‌مانده حالت‌ها عمر (TTL) به میزان `2^19` ثانیه (6 روز) دارند و به همین ترتیب ادامه می‌یابند.

در سال ۲۰۲۴ حالت‌های پایدار بلندمدت (حداقل ۳ ماه) زیر وجود دارد:

|                                                                                     شماره ترتیب بلاک |                                           زمان بلاک |       TTL |                                         تاریخ انقضا |
| ---------------------------------------------------------------------------------------------------: | --------------------------------------------------: | --------: | --------------------------------------------------: |
|   [8930706](https://explorer.toncoin.org/search?workchain=-1\&shard=8000000000000000\&seqno=8930706) | 2021-01-14 15:08:40 | 12427 روز | 2055-01-24 08:45:44 |
| [27747086](https://explorer.toncoin.org/search?workchain=-1\&shard=8000000000000000\&seqno=27747086) | 2023-03-02 05:08:11 |  1553 روز | 2027-06-02 19:50:19 |
| [32638387](https://explorer.toncoin.org/search?workchain=-1\&shard=8000000000000000\&seqno=32638387) | 2023-09-12 09:27:36 |   388 روز | 2024-10-04 18:08:08 |
| [34835953](https://explorer.toncoin.org/search?workchain=-1\&shard=8000000000000000\&seqno=34835953) | 2023-12-18 11:37:48 |   194 روز | 2024-06-29 15:58:04 |
| [35893070](https://explorer.toncoin.org/search?workchain=-1\&shard=8000000000000000\&seqno=35893070) | 2024-02-05 00:42:50 |    97 روز | 2024-05-12 02:52:58 |
| [36907647](https://explorer.toncoin.org/search?workchain=-1\&shard=8000000000000000\&seqno=36907647) | 2024-03-24 13:47:57 |   776 روز | 2026-05-10 07:09:01 |

زمانی که یک نود برای اولین بار شروع به کار می‌کند، باید یک حالت پایدار را دانلود کند. این موضوع در [validator/manager-init.cpp](https://github.com/ton-blockchain/ton/blob/master/validator/manager-init.cpp) پیاده‌سازی شده است.

با شروع از بلاک اولیه، نود تمامی بلاک‌های کلیدی جدیدتر را دانلود می‌کند. این نود، جدیدترین بلاک کلیدی را با یک حالت پایدار موجود (با استفاده از فرمول بالا) انتخاب کرده و سپس حالت مسترچین مربوطه و حالت‌ها برای تمامی شاردها (یا فقط شاردهای مورد نیاز این نود) را دانلود می‌کند.
