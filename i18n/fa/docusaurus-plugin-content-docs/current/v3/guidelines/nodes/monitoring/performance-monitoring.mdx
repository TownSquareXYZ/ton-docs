# نظارت بر عملکرد

## نظارت بر عملکرد سرور TON

ابزارهایی مانند `htop`, `iotop`, `iftop`, `dstat`, `nmon` و سایر موارد برای اندازه‌گیری عملکرد در زمان واقعی خوب هستند، اما وقتی به عیب‌یابی عملکرد گذشته می‌رسد، از لحاظ کارایی کمبودهایی دارند.

این راهنما توصیه می‌کند و توضیح می‌دهد چگونه از ابزار sar (گزارش فعالیت سیستم) در لینوکس برای نظارت بر عملکرد سرور TON استفاده کنید.

:::tip
این راهنما کمک می کند تا تشخیص دهید آیا سرور شما با کمبود منابع روبرو است و برای تشخیص عملکرد بد موتور اعتبار سنجی نیست.
:::

### نصب

#### نصب SAR

```bash
sudo apt-get install sysstat
```

#### فعال کردن جمع‌آوری خودکار آمار

```bash
sudo sed -i 's/false/true/g' /etc/default/sysstat
```

#### فعال سازی سرویس

```bash
sudo systemctl enable sysstat sysstat-collect.timer sysstat-summary.timer
```

#### شروع سرویس

```bash
sudo systemctl start sysstat sysstat-collect.timer sysstat-summary.timer
```

### استفاده

به طور پیش‌فرض، sar هر ۱۰ دقیقه یکبار آمار جمع‌آوری کرده و آمار روز جاری را از نیمه شب نمایش می‌دهد. می‌توانید آن را بدون پارامترها اجرا کنید:

```bash
sar
```

اگر می‌خواهید آمار روز قبل یا دو روز پیش را ببینید، لطفاً عدد را به عنوان گزینه وارد کنید:

```bash
sar -1   # previous day
sar -2   # two days ago
```

برای تاریخ دقیق، باید از گزینه f برای اشاره به فایل sa یک روز خاص از ماه استفاده کنید. بنابراین برای ۲۳ سپتامبر، به این صورت خواهد بود:

```bash
sar -f /var/log/sysstat/sa23
```

کدام گزارش‌های sar باید اجرا شود و چگونه آن‌ها را بخوانیم تا مسائل مربوط به عملکرد را شناسایی کنیم؟

در زیر لیستی از دستورات sar که می‌توان برای جمع‌آوری آمار مختلف سیستم استفاده کرد آمده است. می‌توانید آن‌ها را با گزینه‌های ذیل برای دریافت سریع گزارش‌های تاریخ مورد نظر تکمیل کنید.

### گزارش حافظه

```bash
sar -rh
```

از آنجا که موتور اعتبارسنجی TON از ویژگی jemalloc استفاده می‌کند، حجم زیادی از داده‌ها را در حافظه پنهان ذخیره می‌کند، به همین دلیل است که بیشتر اوقات دستور sar -rh عدد کمتری در ستون `%memused` برمی‌گرداند.

در همان زمان، همیشه عدد بالایی در ستون `kbcached` وجود دارد. به همان دلیل، نباید نگران مقدار کم RAM آزاد شده در ستون `kbmemfree` باشید. نشانگر مهم اما، عددی است که از ستون `%memused` می‌آید.

اگر از ۹۰٪ فراتر رود، باید به فکر افزودن RAM بیشتر باشید و توجه کنید که آیا موتور اعتبارسنجی شما به دلیل OOM (کمبود حافظه) به طرز غیرعادی متوقف نمی‌شود - بهترین روش برای بررسی این موضوع بررسی پیام‌های Signal در فایل `/var/ton-work/log` است.

استفاده از Swap

```bash
sar -Sh
```

اگر متوجه شده‌اید که Swap مورد استفاده قرار می‌گیرد، باید به فکر افزودن RAM بیشتر باشید. توصیه کلی از تیم TON Core این است که Swap را غیرفعال کنید.

### گزارش CPU

```bash
sar -u
```

اگر سرور شما به طور متوسط تا ۷۰٪ از CPU استفاده می‌کند (به ستون '%user' نگاه کنید) این باید به عنوان خوب در نظر گرفته شود.

### گزارش استفاده از دیسک

```bash
sar -dh
```

به ستون '%util' توجه کنید و در صورت باقی ماندن آن بالای ۹۰٪ برای یک دیسک خاص، به‌طور مقتضی واکنش نشان دهید.

### گزارش شبکه

```bash
sar -n DEV -h
```

یا

```bash
sar -n DEV -h --iface=<interface name>
```

اگر می‌خواهید نتایج را بر اساس نام رابط شبکه فیلتر کنید.

نتیجه ستون `%ifutil` را بررسی کنید - این ستون استفاده از رابط شما را با در نظر گرفتن حداکثر سرعت اتصال نشان می‌دهد.

می‌توانید سرعت پشتیبانی شده توسط کارت شبکه خود را با اجرای فرمان زیر بررسی کنید:

```bash
cat /sys/class/net/<interface>/speed
```

:::info
این سرعت اتصال ارائه شده توسط ارائه‌دهنده شما نیست.
:::

اگر `%ifutil` استفاده بالای ۷۰٪ را نشان می‌دهد یا ستون‌های rxkB/s و txkB/s مقادیر نزدیک به پهنای باند ارائه شده توسط ارائه‌دهنده شما را گزارش می‌دهند، ارتقاء سرعت اتصال خود را در نظر بگیرید.

### گزارش یک مشکل عملکردی

قبل از گزارش هرگونه مشکل عملکردی، لطفاً اطمینان حاصل کنید که حداقل شرایط لازم برای نود را برآورده می‌کنید. سپس دستورات زیر را اجرا کنید:

```bash
sar -rudh | cat && sar -n DEV -h --iface=eno1 | cat > report_today.txt
```

برای گزارش دیروز، اجرا کنید:

```bash
sar -rudh -1 | cat && sar -n DEV -h --iface=eno1 -1 | cat > report_yesterday.txt
```

همچنین، نود TON را متوقف کرده و I/O دیسک و سرعت شبکه خود را اندازه‌گیری کنید.

```bash
sudo fio --randrepeat=1 --ioengine=io_uring --direct=1 --gtod_reduce=1 --name=test --filename=/var/ton-work/testfile --bs=4096 --iodepth=1 --size=40G --readwrite=randread --numjobs=1 --group_reporting
```

مقدار `read: IOPS=` را جستجو کنید و آن را با گزارش ارسال کنید. مقداری بالاتر از 10k IOPS باید به عنوان خوب در نظر گرفته شود.

```bash
curl -s https://raw.githubusercontent.com/sivel/speedtest-cli/master/speedtest.py | python3 -
```

سرعت‌های دانلود و آپلود بالای ۷۰۰ مگابیت بر ثانیه باید به عنوان خوب در نظر گرفته شوند.

هنگام گزارش، لطفاً گزارش SAR و همچنین نتایج IOPS و سرعت شبکه را به [@mytonctrl_help_bot](https://t.me/mytonctrl_help_bot) ارسال کنید.

نسخه اولیه توسط [@neodix](https://t.me/neodix) - تیم اصلی Ton، سپتامبر ۲۳، ۲۰۲۴
