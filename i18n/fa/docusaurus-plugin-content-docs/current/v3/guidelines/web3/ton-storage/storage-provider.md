# ارائه دهنده‌ی ذخیره‌سازی

*ارائه دهنده‌ی ذخیره‌سازی* سرویسی است که فایل‌ها را در ازای هزینه ذخیره می‌کند.

## باینری‌ها

شما می‌توانید باینری‌های `storage-daemon` و `storage-daemon-cli` برای Linux/Windows/MacOS را از [TON Auto Builds](https://github.com/ton-blockchain/ton/releases/latest) دانلود کنید.

## کامپایل از سورس‌ها

شما می‌توانید `storage-daemon` و `storage-daemon-cli` را از سورس ها با استفاده از این [دستورالعمل](/v3/guidelines/smart-contracts/howto/compile/compilation-instructions#storage-daemon) کامپایل کنید.

## مفاهیم کلیدی

این شامل یک قرارداد هوشمند است که درخواست‌های ذخیره‌سازی را می‌پذیرد و پرداخت‌های مشتریان را مدیریت می‌کند و همچنین شامل یک برنامه است که فایل‌ها را به مشتریان ارسال و بارگذاری می‌کند. شیوه کار به این صورت است:

1. مالک ارائه دهنده، `storage-daemon` را راه‌اندازی می‌کند، قرارداد هوشمند اصلی را پیاده‌سازی می‌کند و پارامترها را تنظیم می‌کند. آدرس قرارداد با مشتریان احتمالی به اشتراک گذاشته می‌شود.
2. مشتری با استفاده از `storage-daemon` یک کیف از فایل‌های خود می‌سازد و یک پیام داخلی خاص به قرارداد هوشمند ارائه‌دهنده ارسال می‌کند.
3. قرارداد هوشمند ارائه‌دهنده یک قرارداد ذخیره‌سازی ایجاد می‌کند تا این کیف خاص را مدیریت کند.
4. ارائه دهنده، پس از یافتن درخواست در بلاکچین، کیف را دانلود کرده و قرارداد ذخیره‌سازی را فعال می‌کند.
5. سپس مشتری می‌تواند کارمزد ذخیره‌سازی را به قرارداد ذخیره‌سازی منتقل کند. برای دریافت کارمزد، ارائه‌دهنده به‌طور منظم به قرارداد مدرکی ارائه می‌دهد که همچنان در حال ذخیره‌سازی کیف است.
6. اگر وجوه موجود در قرارداد ذخیره‌سازی تمام شود، قرارداد غیر فعال در نظر گرفته می‌شود و ارائه‌دهنده دیگر موظف به نگهداری کیف نیست. مشتری می‌تواند قرارداد را مجدداً شارژ کند یا فایل‌های خود را بازیابی کند.

:::info
همچنین مشتری می‌تواند در هر زمان با ارائه مدرک مالکیت به قرارداد ذخیره‌سازی فایل‌های خود را بازیابی کند. سپس قرارداد فایل‌ها را برای مشتری آزاد کرده و خود را غیرفعال می‌کند.
:::

## قرارداد هوشمند

[سورس کد قرارداد هوشمند](https://github.com/ton-blockchain/ton/tree/master/storage/storage-daemon/smartcont).

## استفاده از ارائه دهنده توسط مشتریان

برای استفاده از ارائه‌دهنده‌ی ذخیره‌سازی، شما نیاز به دانستن آدرس قرارداد هوشمند آن دارید. مشتری می‌تواند پارامترهای ارائه دهنده را با استفاده از دستور زیر در `storage-daemon-cli` به‌دست آورد:

```
get-provider-params <address>
```

### پارامترهای ارائه دهنده:

- اینکه قراردادهای جدید ذخیره‌سازی پذیرفته می‌شوند یا خیر.
- حداقل و حداکثر اندازه‌ی *کیف* (به بایت).
- نرخ - هزینه‌ی ذخیره‌سازی. در قالب nanoTON به ازای هر مگابایت در روز مشخص شده است.
- حداکثر بازه - چقدر باید ارائه‌دهنده اثبات ذخیره‌سازی *کیف* ها را ارائه دهد.

### درخواست برای ذخیره‌سازی

شما نیاز دارید تا یک *کیف فایل* بسازید و پیامی با دستور زیر تولید کنید:

```
new-contract-message <BagID> <file> --query-id 0 --provider <address>
```

### اطلاعات:

اجرای این دستور ممکن است برای *کیف*‌های بزرگ کمی زمان‌بر باشد. بدنه‌ی پیام در `<file>` ذخیره خواهد شد (نه تمامی پیام داخلی). شناسه‌ی جستجو می‌تواند هر عددی از ۰ تا `۲^۶۴-۱` باشد. پیام حاوی پارامترهای ارائه‌دهنده (نرخ و حداکثر بازه) است. این پارامترها پس از اجرای دستور چاپ خواهند شد، بنابراین باید قبل از ارسال دوباره بررسی شوند. اگر مالک ارائه‌دهنده پارامترها را تغییر دهد، پیام رد خواهد شد، به طوری که شرایط قرارداد جدید ذخیره‌سازی دقیقا مورد انتظار مشتری خواهد بود.

سپس مشتری باید پیامی با محتوای این بدنه به آدرس ارائه‌دهنده بفرستد. در صورت بروز خطا پیام به فرستنده برمی‌گردد (برگشت). در غیر این صورت، یک قرارداد ذخیره‌سازی جدید ایجاد می‌شود و مشتری پیامی از آن دریافت خواهد کرد با [`op=0xbf7bd0c1`](https://github.com/ton-blockchain/ton/tree/testnet/storage/storage-daemon/smartcont/constants.fc#L3) و همان شناسه جستجو.

در این مرحله قرارداد هنوز فعال نشده است. وقتی ارائه‌دهنده *کیف* را دانلود کند، قرارداد ذخیره‌سازی فعال می‌شود و مشتری پیامی با [`op=0xd4caedcd`](https://github.com/SpyCheese/ton/blob/tonstorage/storage/storage-daemon/smartcont/constants.fc#L4) دریافت می‌کند (همچنین از قرارداد ذخیره‌سازی).

قرارداد ذخیره‌سازی دارای «مانده‌ی مشتری» است - این وجوهی هستند که مشتری به قرارداد منتقل کرده و هنوز به ارائه‌دهنده پرداخت نشده‌اند. وجوه به تدریج از این موجودی کسر می‌شوند (با نرخ برابر با نرخ در هر مگابایت در روز). موجودی اولیه همان چیزی است که مشتری با درخواست ایجاد قرارداد ذخیره‌سازی انتقال داده است. سپس مشتری می‌تواند با انجام انتقالات ساده به قرارداد ذخیره‌سازی موجودی را افزایش دهد (این امر می‌تواند از هر آدرسی انجام شود). مانده‌ی مشتری باقی‌مانده با متد [`get_storage_contract_data`](https://github.com/ton-blockchain/ton/tree/testnet/storage/storage-daemon/smartcont/storage-contract.fc#L222) در مقدار دوم با عنوان (`balance`) بازگردانده می‌شود.

### قرارداد ممکن است به دلیل موارد زیر بسته شود:

:::info
در صورت بسته شدن قرارداد ذخیره‌سازی، مشتری پیامی با موجودی باقیمانده و [`op=0xb6236d63`](https://github.com/ton-blockchain/ton/tree/testnet/storage/storage-daemon/smartcont/constants.fc#L6) دریافت می‌کند.
:::

- بلافاصله پس از ایجاد، قبل از فعال‌سازی، اگر ارائه‌دهنده از پذیرفتن قرارداد خودداری کند (محدودیت ارائه‌دهنده تجاوز کرده یا خطاهای دیگر).
- موجودی مشتری به ۰ می‌رسد.
- ارائه‌دهنده می‌تواند به‌صورت داوطلبانه قرارداد را منتفی کند.
- مشتری می‌تواند به طور داوطلبانه قرارداد را با ارسال پیامی با [`op=0x79f937ea`](https://github.com/ton-blockchain/ton/tree/testnet/storage/storage-daemon/smartcont/constants.fc#L2) از آدرس خود و هر شناسه استعلامی منتفی کند.

## راه‌اندازی و پیکربندی یک تامین‌کننده

تامین‌کننده ذخیره‌سازی بخشی از `storage-daemon` است و توسط `storage-daemon-cli` مدیریت می‌شود. `storage-daemon` باید با علامت `-P` شروع شود.

### ایجاد یک قرارداد هوشمند اصلی

می‌توانید این کار را از `storage-daemon-cli` انجام دهید:

```
deploy-provider
```

:::info مهم!
از شما خواسته خواهد شد که برای راه‌اندازی تامین‌کننده، یک پیام غیرقابل برگشت با ۱ تن به آدرس مشخص شده ارسال کنید. شما می‌توانید با استفاده از فرمان `get-provider-info` وضعیت قرارداد را بررسی کنید.
:::

به طور پیش‌فرض، قرارداد تنظیم شده است که قراردادهای ذخیره‌سازی جدیدی را نپذیرد. قبل از فعال‌سازی آن، باید تامین‌کننده را پیکربندی کنید. تنظیمات تامین‌کننده از یک پیکربندی (ذخیره شده در `storage-daemon`) و پارامترهای قرارداد (ذخیره شده در بلاکچین) تشکیل شده است.

### پیکربندی:

- `max contracts` - حداکثر تعداد قراردادهای ذخیره‌سازی که می‌توانند به طور همزمان وجود داشته باشند.
- `max total size` - حداکثر اندازه کل *کیف‌ها* در قراردادهای ذخیره‌سازی.
  شما می‌توانید مقدارهای پیکربندی را با استفاده از `get-provider-info` مشاهده کرده و با استفاده از موارد زیر تغییر دهید:

```
set-provider-config --max-contracts 100 --max-total-size 100000000000
```

### پارامترهای قرارداد:

- `accept` - آیا قراردادهای ذخیره‌سازی جدید را پذیرا هستیم یا خیر.
- `max file size`, `min file size` - محدودیت اندازه برای یک *کیف‌فایل*.
- `rate` - هزینه ذخیره‌سازی (در قالب nanoTON برای هر مگابایت در روز).
- `max span` - تعداد دفعاتی که تامین‌کننده باید مدارک ذخیره‌سازی را ارائه دهد.

شما می‌توانید پارامترها را با استفاده از `get-provider-info` مشاهده کنید و آن‌ها را به صورت زیر تغییر دهید:

```
set-provider-params --accept 1 --rate 1000000000 --max-span 86400 --min-file-size 1024 --max-file-size 1000000000
```

### ارزش توجه دارد

توجه: در فرمان `set-provider-params`، شما می‌توانید فقط بعضی از پارامترها را مشخص کنید. بقیه از پارامترهای فعلی گرفته خواهند شد. با توجه به اینکه داده‌ها در بلاکچین به صورت لحظه‌ای به‌روز نمی‌شوند، چندین فرمان `set-provider-params` متوالی می‌تواند به نتایج غیرمنتظره منجر شود.

توصیه می‌شود به طور اولیه بیش از ۱ تن در موجودی تامین‌کننده قرار دهید تا بودجه کافی برای پوشش کمیسیون‌ها برای کار با قراردادهای ذخیره‌سازی وجود داشته باشد. با این حال، نباید بیش از حد زیاد تن در اولین پیام ارسال کنید زیرا غیرقابل برگشت است.

پس از تنظیم پارامتر `accept` به `1`، قرارداد هوشمند شروع به پذیرفتن درخواست‌ها از مشتری‌ها و ایجاد قراردادهای ذخیره‌سازی خواهد کرد، در حالی که دیمون ذخیره‌سازی به طور خودکار آن‌ها را پردازش می‌کند: دانلود و توزیع *کیف‌ها*، تولید مدارک ذخیره‌سازی.

## کار بیشتر با تامین‌کننده

### لیست قراردادهای ذخیره‌سازی موجود

```
get-provider-info --contracts --balances
```

هر قرارداد ذخیره‌سازی یک تراز `Client$` و `Contract$` دارد. تفاوت بین آن‌ها می‌تواند با فرمان `withdraw <address>` به قرارداد اصلی تامین‌کننده منتقل شود.

فرمان `withdraw-all` وجوه را از تمام قراردادهایی که حداقل ۱ تن در دسترس دارند برداشت می‌کند.

هر قرارداد ذخیره‌سازی را می‌توان با فرمان `close-contract <address>` بست. این نیز وجوه را به قرارداد اصلی منتقل می‌کند. زمانی که موجودی مشتری به پایان برسد، همین حالت به طور خودکار اتفاق می‌افتد. در این صورت فایل‌های *کیف* حذف خواهند شد (مگر اینکه قراردادهای دیگری وجود داشته باشند که از همان *کیف* استفاده کنند).

### انتقال

می‌توانید وجوه را از قرارداد هوشمند اصلی به هر آدرسی منتقل کنید (مقدار در قالب nanoTON است):

```
send-coins <address> <amount>
send-coins <address> <amount> --message "Some message"
```

:::info
تمام *کیف‌هایی* که توسط تامین‌کننده ذخیره شده‌اند با فرمان `list` در دسترس هستند و می‌توانند به صورت معمول استفاده شوند. برای جلوگیری از اختلال در عملیات تامین‌کننده، آن‌ها را حذف نکنید یا این دیمون ذخیره‌سازی را برای کار با *کیف‌های* دیگر استفاده نکنید.
:::
