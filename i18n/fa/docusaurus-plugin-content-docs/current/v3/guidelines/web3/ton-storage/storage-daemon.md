# دیمون ذخیره‌سازی

*دیمون ذخیره‌سازی برنامه‌ای است که برای دانلود و به اشتراک گذاری فایل‌ها در شبکه TON استفاده می‌شود. برنامه کنسول `storage-daemon-cli` برای مدیریت دیمون ذخیره‌سازی در حال اجرا استفاده می‌شود.*

نسخه فعلی دیمون ذخیره‌سازی را می‌توان در شاخه [Testnet](https://github.com/ton-blockchain/ton/tree/testnet) پیدا کرد.

## نیازمندی‌های سخت‌افزاری

- حداقل 1GHz و 2 هسته CPU
- حداقل 2 گیگابایت RAM
- حداقل 2 گیگابایت حافظه SSD (بدون احتساب فضای مورد نیاز برای تورنت)
- پهنای باند شبکه 10 مگابایت در ثانیه با IP ثابت

## باینری‌ها

شما می‌توانید باینری‌های `storage-daemon` و `storage-daemon-cli` برای Linux/Windows/MacOS را از [TON Auto Builds](https://github.com/ton-blockchain/ton/releases/latest) دانلود کنید.

## کامپایل از سورس‌ها

شما می‌توانید `storage-daemon` و `storage-daemon-cli` را از سورس ها با استفاده از این [دستورالعمل](/v3/guidelines/smart-contracts/howto/compile/compilation-instructions#storage-daemon) کامپایل کنید.

## مفاهیم کلیدی

- *مجموعه فایل‌ها* یا *کیف* - مجموعه‌ای از فایل‌ها که از طریق ذخیره‌سازی TON توزیع می‌شود
- بخش شبکهٔ TON Storage بر اساس تکنولوژی مشابه با تورنت‌ها است، بنابراین اصطلاحات *تورنت*، *کیف فایل‌ها* و *کیف* به صورت متناوب استفاده خواهند شد. با این حال، توجه به برخی تفاوت‌ها مهم است: TON Storage داده‌ها را از طریق [ADNL](/v3/documentation/network/protocols/adnl/overview) با پروتکل [RLDP](/v3/documentation/network/protocols/rldp) منتقل می‌کند، هر *کیف* از طریق پوشش شبکهٔ خود توزیع می‌شود، ساختار مرکل می‌تواند در دو نسخه وجود داشته باشد - با قطعات بزرگ برای دانلود کارآمد و کوچک برای اثبات مالکیت کارآمد، و شبکهٔ [TON DHT](/v3/documentation/network/protocols/dht/ton-dht) برای یافتن همتاها استفاده می‌شود.
- یک *مجموعه فایل‌ها* شامل *اطلاعات تورنت* و یک بلوک داده است.
- بلوک داده با یک *سرفصل تورنت* شروع می‌شود - ساختاری که شامل فهرستی از فایل‌ها با نام‌ها و اندازه‌هایشان است. خود فایل‌ها در بلوک داده دنبال می‌شوند.
- بلاک داده به بخش‌هایی (به طور پیش‌فرض ۱۲۸ کیلوبایت) تقسیم می‌شود و یک *درخت مرکل* (ساخته شده از سلول‌های TVM) بر روی هش‌های SHA256 این بخش‌ها ساخته می‌شود. این امکان را فراهم می‌کند که *اثبات‌های مرکل* بخش‌های منفرد ساخته و تأیید شوند، همچنین به طور کارآمد *کیف* را با تبادل تنها اثبات بخش تغییر یافته بازسازی کند.
- *اطلاعات تورنت* شامل *ریشه مرکل*
    - اندازه قسمت (بلوک داده)
    - فهرست اندازه‌های قسمت‌ها
    - هش *درخت مرکل*
    - توضیحات - هر متنی که توسط ایجادکننده تورنت مشخص شده باشد
- *اطلاعات تورنت* به یک سلول TVM سریالیزه می‌شود. هش این سلول گاهی به نام *BagID* شناخته می‌شود و به طور منحصربه‌فرد *کیف* را شناسایی می‌کند.
- *متا کیف* یک فایل است که شامل *اطلاعات تورنت* و *سرفصل تورنت* است. این یک آنالوگ فایل‌های `.torrent` است.

## شروع دیمون ذخیره‌سازی و storage-daemon-cli

### مثال دستوری برای شروع storage-daemon:

`storage-daemon -v 3 -C global.config.json -I <ip>:3333 -p 5555 -D storage-db`

- `-v` - سطح فراوانی (INFO)
- `-C` - تنظیم شبکهٔ جهانی ([دانلود تنظیم جهانی](/v3/guidelines/smart-contracts/howto/compile/compilation-instructions#download-global-config))
- `-I` - آدرس IP و پورت برای adnl
- `-p` - پورت TCP برای رابط کنسول
- `-D` - دایرکتوری برای پایگاه داده دیمون ذخیره‌سازی

### مدیریت storage-daemon-cli

اینطور شروع می‌شود:

```
storage-daemon-cli -I 127.0.0.1:5555 -k storage-db/cli-keys/client -p storage-db/cli-keys/server.pub
```

- `-I` - این همان آدرس IP و پورت دیمون است (پورت همان پورت مشخص شده در پارامتر `-p` بالاست)
- `-k` و `-p` - این‌ها کلید خصوصی کلاینت و کلید عمومی سرور هستند (مشابه `validator-engine-console`). این کلیدها در اولین اجرای دیمون ایجاد می‌شوند و در `<db>/cli-keys/` قرار می‌گیرند.

### فهرست دستورها

فهرست دستورات `storage-daemon-cli` می‌تواند با دستور `help` به دست آید.

دستورها دارای پارامترهای مکانی و علامت‌ها هستند. پارامترهایی با فاصله‌ها باید داخل نقل قول (\`\` یا `"`) قرار گیرند، فاصله‌ها نیز می‌توانند فرار داده شوند. راهکار های دیگری در دسترس است، به عنوان مثال:

```
create filename\ with\ spaces.txt -d "Description\nSecond line of \"description\"\nBackslash: \\"
```

همه پارامترها بعد از علامت `--` پارامترهای مکانی هستند. می‌تواند برای مشخص کردن نام فایل‌هایی که با یک خط تیره شروع می‌شوند استفاده شود:

```
create -d "Description" -- -filename.txt
```

`storage-daemon-cli` می‌تواند با گذراندن دستورات برای اجرا در حالت غیر تعاملی اجرا شود:

```
storage-daemon-cli ... -c "add-by-meta m" -c "list --hashes"
```

## افزودن کیف فایل‌ها

برای دانلود یک *کیف فایل‌ها*، باید `BagID` آن را بدانید یا یک فایل متا داشته باشید. دستورها زیر می‌تواند برای افزودن یک *مجموعه* برای دانلود استفاده شود:

```
add-by-hash <hash> -d directory
add-by-meta <meta-file> -d directory
```

*کیف* به دایرکتوری مشخص شده دانلود خواهد شد. می‌توانید این را حذف کنید، سپس در دایرکتوری دیمون ذخیره‌سازی ذخیره خواهد شد.

:::info
هش در قالب هگزادسیمال مشخص می‌شود (طول - 64 کاراکتر).
:::

هنگام اضافه کردن *کیف* به‌وسیله یک فایل متا، اطلاعات درباره *کیف* بلافاصله در دسترس خواهد بود: اندازه، توضیحات، فهرست فایل‌ها. هنگام اضافه کردن با هش، باید منتظر بمانید تا این اطلاعات بارگذاری شوند.

## مدیریت کیف‌های افزوده شده

- دستور `list` فهرستی از *کیف‌ها* را نمایش می‌دهد.
- `list --hashes` فهرستی با هش‌های کامل را نمایش می‌دهد.

در تمام دستورهای بعدی، `<BagID>` یا یک هش (هگزادسیمال) یا یک شماره ترتیبی *کیف* در جلسه (شماره‌ای که توسط دستور `list` در فهرست دیده می‌شود) است. شماره‌های ترتیبی *کیف‌ها* بین راه‌اندازی مجدد storage-daemon-cli ذخیره نمی‌شوند و در حالت غیر تعاملی در دسترس نیستند.

### روش‌ها

- `get <BagID>` - اطلاعات دقیق در مورد *کیف* را نمایش می‌دهد: توضیحات، اندازه، سرعت دانلود، فهرست فایل‌ها.
- `get-peers <BagID>` - فهرستی از همتاها را نمایش می‌دهد.
- `download-pause <BagID>`, `download-resume <BagID>` - دانلود را متوقف یا از سر می‌گیرد.
- `upload-pause <BagID>`, `upload-resume <BagID>` - آپلود را متوقف یا از سر می‌گیرد.
- `remove <BagID>` - *کیف* را حذف می‌کند. `remove --remove-files` همچنین تمامی فایل‌های *کیف* را حذف می‌کند. توجه داشته باشید که اگر *کیف* در دایرکتوری داخلی دیمون ذخیره‌ساز ذخیره شده باشد، فایل‌ها در هر صورت حذف خواهند شد.

## دانلود جزئی، اولویت‌ها

:::info
هنگام افزودن یک *کیف* می‌توانید تعیین کنید که کدام فایل‌ها را می‌خواهید دانلود کنید:
:::

```
add-by-hash <hash> -d dir --partial file1 file2 file3
add-by-meta <meta-file> -d dir --partial file1 file2 file3
```

### اولویت‌ها

هر فایل در *کیف فایل‌ها* اولویتی بین ۰ تا ۲۵۵ دارد. اولویت ۰ به این معنی است که فایل دانلود نمی‌شود. فلگ `--partial` فایل‌های مشخص شده را به اولویت ۱ و بقیه را به ۰ تنظیم می‌کند.

می‌توانید اولویت‌های *کیف* موجود را با دستورهای زیر تغییر دهید:

- `priority-all <BagID> <priority>` - برای همه فایل‌ها.
- `priority-idx <BagID> <idx> <priority>` - برای یک فایل بر اساس شماره (با فرمان `get` ببینید).
- `priority-name <BagID> <name> <priority>` - برای یک فایل با نام.
    اولویت‌ها حتی قبل از دانلود فهرست فایل‌ها می‌توانند تنظیم شوند.

## ایجاد کیف فایل‌ها

برای ایجاد یک *کیف* و شروع به توزیع آن، از فرمان `create` استفاده کنید:

```
create <path>
```

`<path>` می‌تواند به یک فایل واحد یا یک دایرکتوری اشاره کند. وقتی *کیف*ی ایجاد می‌کنید، می‌توانید توضیحی مشخص کنید:

```
create <path> -d "Bag of Files description"
```

پس از ایجاد *کیف*، کنسول اطلاعات دقیقی درباره آن نمایش می‌دهد (از جمله هش که همان `BagID` است که بر اساس آن *کیف* شناسایی می‌شود) و دیمون شروع به توزیع تورنت می‌کند. گزینه‌های اضافی برای `create`:

- `--no-upload` - daemon فایل‌ها را به همتاها توزیع نخواهد کرد. آپلود می‌تواند با استفاده از `upload-resume` شروع شود.
- `--copy` - فایل‌ها در یک دایرکتوری داخلی دیمون ذخیره‌سازی کپی خواهند شد.

برای دانلود *کیف*، سایر کاربران فقط باید هش آن را بدانند. شما همچنین می‌توانید فایل متای تورنت را ذخیره کنید:

```
get-meta <BagID> <meta-file>
```
